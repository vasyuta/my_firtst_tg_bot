import requests
import random
import telebot
from bs4 import BeautifulSoup as b
from telebot import types
from datetime import datetime

now = datetime.now()

current_time = now.strftime("%H:%M")

API_KEY = '5867077652:AAEOazAHPbt0p4nFFFjfyyMwIOnQpTz2hPo'
yandex = 'https://ezdy.ru/raspisanie-poezdov/novodachnaia--okruzhnaia-moskva-i-moskovskaia-oblast/elektrichki/08.12.2022/'

def parser(link):
    req = requests.get(link)
    soup = b(req.text, 'html.parser')
    times = soup.find_all('span', class_='_time')
    all_times = [c.text for c in times]
    clear_times = []
    int_times = []
    for j in range(len(all_times)):
        str1 = all_times[j]
        a = int(str1[11]) * 1000 + int(str1[12]) * 100 + int(str1[14]) * 10 + int(str1[15])
        int_times.append(a)
    d = int(current_time[0]) * 1000 + int(current_time[1]) * 100 + int(current_time[3]) * 10 + int(current_time[4])
    for i in range(len(int_times)):
        if int_times[2 * i] > d:
            if int_times[2 * i] < 999:
                imsoglad = str(int_times[2 * i])
                imsoglad2 = str(int_times[2 * i + 2])
                return('–°–ª–µ–¥—É—é—â–∞—è –±—É–¥–µ—Ç –≤ 0' + imsoglad[0] + ':'
                       + imsoglad[1] + imsoglad[2] + ', –Ω–æ –µ—Å–ª–∏ –Ω–µ —É—Å–ø–µ–≤–∞–µ—à—å, —Ç–æ –º–æ–∂–Ω–æ –Ω–∞ 0'+ imsoglad2[0] + ':'
                       + imsoglad2[1] + imsoglad2[2])
            if int_times[i] >= 999:
                imsoglad3 = str(int_times[2 * i])
                imsoglad4 = str(int_times[2 * i + 2])
                return ('–°–ª–µ–¥—É—é—â–∞—è –±—É–¥–µ—Ç –≤ ' + imsoglad3[0] + imsoglad3[1] + ':'
                       + imsoglad3[2] + imsoglad3[3] + ', –Ω–æ –µ—Å–ª–∏ –Ω–µ —É—Å–ø–µ–≤–∞–µ—à—å, —Ç–æ –º–æ–∂–Ω–æ –Ω–∞ '+ imsoglad4[0] +
                       imsoglad4[1] + ':' + imsoglad4[1] + imsoglad4[2])



list_Timetable = parser(yandex)

bot = telebot.TeleBot(API_KEY)

@bot.message_handler(commands=['start'])
def start(message):
    question = f'<b>–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}</b>! –ú–µ–Ω—è –∑–æ–≤—É—Ç –≠–ª–µ–∫—Ç—Ä–∏—á–∫–µ—Ä-–±–æ—Ç. –Ø —É–º–µ—é —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —É —Ç–µ–±—è, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å' \
           f'—ç–ª–µ–∫—Ç—Ä–∏—á–∫–∏ —Ç–µ–±–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞. –ü–æ–∫–∞ —á—Ç–æ –≤—Å—ë, –Ω–æ –≤ –±—É–¥—É—â–µ–º —Ç—É—Ç –±—É–¥–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ –µ—â—ë :) \n' \
           f'–ß—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ? –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è? –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ? –ò—Å—Ç–æ—Ä–∏—è-—Ä–∂–æ–º–±–∞?'
    keyboard = types.InlineKeyboardMarkup();
    key_info1 = types.InlineKeyboardButton(text='–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', callback_data='info1');
    keyboard.add(key_info1);
    key_raspis1 = types.InlineKeyboardButton(text='–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', callback_data='raspis1');
    keyboard.add(key_raspis1);
    key_history1 = types.InlineKeyboardButton(text='–ò—Å—Ç–æ—Ä–∏—è-—Ä–∂–æ–º–±–∞', callback_data='history1');
    keyboard.add(key_history1);
    bot.send_message(message.chat.id, question, reply_markup=keyboard, parse_mode='html')

@bot.message_handler(content_types=['text'])
def text_message(message):
    if message.text == '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ':
        bot.send_message(message.chat.id, list_Timetable, parse_mode='html')
    if message.text == '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è':
        bot.send_message(message.chat.id, f'–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å —ç–ª–µ–∫—Ç—Ä–∏—á–∫–∏: \n \n'
                                          f'‚åõ–ê—Ä—Ö–∏–≤–Ω—ã–µ: –≠–†2–†, –≠–†2–¢, –≠–î2–¢, –≠–î4–ú–ö, –≠–î4–ú–ö–ú-–ê–≠–†–û \n'
                                          f'‚öô–î–µ–π—Å—Ç–≤—É—é—â–∏–µ: –≠–î4–ú, –≠–ü2–î, –≠–ì2–¢–≤ "–ò–≤–æ–ª–≥–∞" \n'
                                          f'üèô–ë—É–¥—É—â–∏–µ: –≠–ì–≠2–¢–≤', parse_mode='html')
    if message.text == '–ò—Å—Ç–æ—Ä–∏—è-—Ä–∂–æ–º–±–∞':
        bot.send_message(message.chat.id, f'–û–æ–æ, –≤–æ—Ç —ç—Ç–æ –ø–æ-–Ω–∞—à–µ–º—É! :)\n–ö–∞–∫—É—é —Ö–æ—á–µ—à—å: –±–∞—è–Ω –∏–ª–∏ –ø–æ—Å–≤–µ–∂–µ–µ?', parse_mode='html')
    if message.text == '–ë–∞—è–Ω' or message.text == '–±–∞—è–Ω':
        bot.send_message(message.chat.id, f'–°–≤–µ—Ç–∞–ª–æ... —Å–ª–µ–≥–∫–∞. –ù–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞—é—â–∏–π –º–∞—à–∏–Ω–∏—Å—Ç –Ω–∞–∏–≤–Ω–æ –≤–µ–ª —Å–≤–æ–π —ç–ª–µ–∫—Ç—Ä–æ–ø–æ–µ–∑–¥.'
                                          f' –û–Ω –æ–ø—Ä–æ–º–µ—Ç—á–∏–≤–æ –∑–∞–±—ã–ª, —á—Ç–æ –ø–µ—Ä–≤–æ–µ –∞–ø—Ä–µ–ª—è —É–∂–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –æ–Ω –æ—á–µ–Ω—å —É–¥–∏–≤–∏–ª—Å—è,'
                                          f' –∫–æ–≥–¥–∞ —Ä–µ–ª—å—Å—ã –≤–¥—Ä—É–≥ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ë–µ–¥–Ω—ã–π –º–∞—à–∏–Ω–∏—Å—Ç... –†–∞–∑–≥–∞–¥–∫–∞ —ç—Ç–æ–π –Ω–µ–≥—É–º–∞–Ω–Ω–æ–π —à—É—Ç–∫–∏'
                                          f' —Å–æ—Å—Ç–æ—è–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –∑–∞ –Ω–æ—á–Ω–æ–π –ø–µ—Ä–µ—Ä—ã–≤ –≤ —Ä–∞–±–æ—Ç–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ–∫ —Å—Ç—É–¥–µ–Ω—Ç—ã –ø–æ–∫—Ä–∞—Å–∏–ª–∏ —Ä–µ–ª—å—Å—ã –º–µ–∂–¥—É'
                                          f' "–ù–æ–≤–æ–¥–∞—á–Ω–æ–π" –∏ "–î–æ–ª–≥–æ–ø—Ä—É–¥–Ω–æ–π" –≤ —á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç. –ß–µ—Ä–µ–∑ –≥–æ–¥ (–ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∞–ø—Ä–µ–ª—è) –æ—Ç'
                                          f' —ç–ª–µ–∫—Ç—Ä–æ–¥–µ–ø–æ –ø—Ä–∏—à–ª–∞ –≤ —Ä–µ–∫—Ç–æ—Ä–∞—Ç –ø—Ä–æ—Å—å–±–∞ ‚Äî —Ä–µ–ª—å—Å—ã –±–æ–ª—å—à–µ –Ω–µ –∫—Ä–∞—Å–∏—Ç—å.'
                                          f' –î–∞ –∏ –º—ã —Å–∞–¥–∏—Å—Ç–∞–º–∏ –Ω–µ –±—ã–ª–∏ :)', parse_mode='html')
    if message.text == '–ü–æ—Å–≤–µ–∂–µ–µ' or message.text == '–ø–æ—Å–≤–µ–∂–µ–µ':
        bot.send_message(message.chat.id, f'–í 2020-–º –≥–æ–¥—É –†–ñ–î –ø–µ—Ä–µ–¥–∞–≤–∞–ª–æ –º–æ—Ç–æ—Ä–≤–∞–≥–æ–Ω–Ω–æ–µ –¥–µ–ø–æ "–õ–æ–±–Ω—è" –¶–ü–ü–ö. –ü–æ –∑–∞–∫–æ–Ω—É, –≤ —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ–µ—Å—Å'
                                          f' –º–æ–∂–µ—Ç –≤–≤—è–∑–∞—Ç—å—Å—è –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π, –∏ —Ö–æ—Ç—è –æ–±—ã—á–Ω–æ —ç—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–∞–ª–∞—Å—å —Ç–µ–Ω–¥–µ—Ä–∞–º–∏ —Å —É–∑–∫–∏–º–∏'
                                          f' —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é, –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –º–æ–Ω–æ–ø–æ–ª–∏—Å—Ç —Ä–µ—à–∏–ª –ø—Ä–æ–±–ª–µ–º—É'
                                          f' –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ: <b> –¥–µ–ø–æ –¢–ß-14 –õ–æ–±–Ω—è –±—ã–ª–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ê–≤–∏—Ç–æ</b>. –õ—é–±–æ–π –∂–µ–ª–∞—é—â–∏–π –º–æ–≥ —Å–≤—è–∑–∞—Ç—å—Å—è'
                                          f' —Å –†–ñ–î –∏ –≤—Å–µ–≥–æ –∑–∞ 270 –º–ª–Ω —Ä—É–±–ª–µ–π –≤ –≥–æ–¥ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–ª–µ–∫—Ç—Ä–∏—á–∫–µ—Ä—Å–∫–æ–≥–æ'
                                          f' –¥–µ–ø–æ –°–∞–≤—ë–ª–æ–≤—Å–∫–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ò –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–æ–≥–∞–¥—ã–≤–∞—Ç—å—Å—è, —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–∫–æ–ª–∏—Å—Ç–æ–≤ –ø–æ–∑–≤–æ–Ω–∏–ª–æ'
                                          f' –Ω–∞ —ç—Ç–æ—Ç –±–µ–¥–Ω—ã–π –Ω–æ–º–µ—Ä...', parse_mode='html')
    if (message.text != '–ü–æ—Å–≤–µ–∂–µ–µ' and message.text != '–ë–∞—è–Ω' and message.text != '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' and message.text != '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ'
    and message.text != '–ò—Å—Ç–æ—Ä–∏—è-—Ä–∂–æ–º–±–∞'):
        text1 = f'–Ø —Ç–∞–∫ –Ω–µ –∏–≥—Ä–∞—é :( \n{message.from_user.first_name}, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ!'
        bot.send_message(message.chat.id, text1, parse_mode='html')
bot.polling()
